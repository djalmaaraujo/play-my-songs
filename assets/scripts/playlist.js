// Generated by CoffeeScript 1.6.3
(function() {
  var Playlist;

  Playlist = (function() {
    function Playlist() {
      if (this.checkForFileAPISupport()) {
        this.setElements();
        this.createAudioAPIElements();
        this.handlers();
      } else {
        alert("Your browser don't support drag and drop, get out of here!");
      }
    }

    Playlist.prototype.checkForFileAPISupport = function() {
      return typeof window.FileReader === 'function';
    };

    Playlist.prototype.setElements = function() {
      this.holder = $('#playlist');
      return this.player = $('#player');
    };

    Playlist.prototype.handlers = function() {
      this.handleDragOver();
      this.handleDragDrop();
      return this.handlerPlaySong();
    };

    Playlist.prototype.handleDragOver = function() {
      var _this = this;
      return this.holder.on('dragover', function(event) {
        event.preventDefault();
        return _this.holder.addClass('drag-over');
      });
    };

    Playlist.prototype.handleDragDrop = function() {
      var _this = this;
      return this.holder.on('drop', function(event) {
        event.preventDefault();
        return _this.populatePlaylist(event.dataTransfer.files);
      });
    };

    Playlist.prototype.handlerPlaySong = function() {
      var _this = this;
      return this.holder.on('click', function(event) {
        var songID;
        event.preventDefault();
        songID = $(event.target).data('song');
        return _this.play(songID);
      });
    };

    Playlist.prototype.populatePlaylist = function(songs) {
      var song, _i, _len;
      this.storage = songs;
      this.holder.html('');
      for (_i = 0, _len = songs.length; _i < _len; _i++) {
        song = songs[_i];
        this.insertSong(song, _i);
      }
      return this.play(0);
    };

    Playlist.prototype.play = function(songID) {
      var file, self;
      self = this;
      if (!this.storage[songID]) {
        return alert('Song not found');
      } else {
        this.stop();
        file = new FileReader();
        file.onload = function(fileEvent) {
          return self.createAudio(fileEvent.target.result);
        };
        file.readAsArrayBuffer(this.storage[songID]);
        this.removeActiveClass();
        return this.holder.find('a.song-' + songID + '').parent().addClass('active');
      }
    };

    Playlist.prototype.stop = function() {
      if (this.audioSource) {
        this.audioSource.stop(0);
      }
      return this.createAudioAPIElements();
    };

    Playlist.prototype.removeExtension = function(song) {
      return song.split('.')[0];
    };

    Playlist.prototype.createAudioAPIElements = function() {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      return this.audioSource = this.audioContext.createBufferSource();
    };

    Playlist.prototype.createAudio = function(data) {
      var self;
      self = this;
      if (self.audioContext.decodeAudioData) {
        return self.audioContext.decodeAudioData(data, function(buffer) {
          self.audioSource.buffer = buffer;
          self.audioSource.connect(self.audioContext.destination);
          return self.audioSource.start(0);
        }, function(e) {
          return alert('Error loading this file');
        });
      }
    };

    Playlist.prototype.insertSong = function(song, index) {
      if (song.type.match(/audio.*/)) {
        return this.holder.append('<li><a href="#" data-song="' + index + '" class="song-' + index + '">' + this.removeExtension(song.name) + '</a></li>');
      }
    };

    Playlist.prototype.removeActiveClass = function() {
      return this.holder.find('li').removeClass('active');
    };

    return Playlist;

  })();

  this.Playlist = Playlist;

}).call(this);
